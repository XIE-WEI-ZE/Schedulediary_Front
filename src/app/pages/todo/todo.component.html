<div class="layout">
  <header class="header">
    <h2>📅 我的行事曆 ToDo 系統</h2>
  </header>

  <nav class="sidebar">
    <h5>功能選單</h5>
    <button (click)="activeTab = 'add'">➕ 新增事項</button>
    <button (click)="toggleQueryMenu()">📁 查詢事項 {{ queryMenuOpen ? '⯆' : '⯈' }}</button>
    <div *ngIf="queryMenuOpen" class="submenu">
      <button (click)="activeTab = 'today'; getTodayTodos()">📅 今日資料</button>
      <button (click)="activeTab = 'all'; getAllTodos()">📖 全部資料</button>
    </div>
    <button (click)="logout()">🚪 登出</button>
  </nav>

  <main class="main-content">
    <!-- 新增事項 -->
    <div *ngIf="activeTab === 'add'" class="form-wrapper modern-form">
      <h4><i class="fas fa-plus-circle"></i> 新增待辦事項</h4>

      <!-- 標題 -->
      <div class="form-group floating">
        <input type="text" id="title" [(ngModel)]="newTodo.title" placeholder=" " />
        <label for="title">標題</label>
      </div>

      <!-- 內容 -->
      <div class="form-group floating">
        <textarea id="content" [(ngModel)]="newTodo.content" placeholder=" "></textarea>
        <label for="content">內容</label>
      </div>

      <!-- 日期 -->
      <div class="form-group floating">
        <input type="date" id="date" [(ngModel)]="newTodo.date" />
        <label for="date">日期</label>
      </div>

      <!-- 優先級（星星） -->
      <div class="form-group">
        <label>優先級</label>
        <div class="star-rating">
          <i
            *ngFor="let star of [1, 2, 3, 4, 5]"
            class="fa-star"
            [class.fa-solid]="newTodo.priorityLevel >= star"
            [class.fa-regular]="newTodo.priorityLevel < star"
            (click)="newTodo.priorityLevel = star"
          ></i>
        </div>
      </div>

      <!-- 類別標籤 -->
      <div class="form-group">
        <label>類別標籤（最多三個）</label>
        <div class="tag-row">
          <span class="tag" *ngFor="let tag of newTags; let i = index">
            #{{ tag }} <button type="button" (click)="removeTag(i)">✖</button>
          </span>
        </div>
        <div class="tag-input-group">
          <input type="text" maxlength="10" [(ngModel)]="tagInput" placeholder="輸入標籤…" (keydown.enter)="addTag()" />
          <button type="button" class="btn-add-tag" (click)="addTag()">
            <i class="fas fa-plus"></i> 新增
          </button>
        </div>
      </div>

      <!-- 確認按鈕 -->
      <div class="form-actions">
        <button class="confirm-btn" (click)="addTodo()">
          <i class="fas fa-check"></i> 新增事項
        </button>
      </div>
    </div>

    <!-- 查詢結果（今日 / 全部） -->
    <div *ngIf="activeTab === 'today' || activeTab === 'all'" class="todo-list">
      <h4>📋 {{ activeTab === 'today' ? '今日資料' : '全部資料' }}</h4>

      <!-- 搜尋區域 -->
      <div class="search-bar-container">
        <input type="text" class="search-input" placeholder="搜尋關鍵字…" [(ngModel)]="searchCriteria.keyword" />
        <button class="icon-btn icon-search" (click)="searchTodos()" title="搜尋">
          <i class="fas fa-search"></i>
        </button>
        <button class="icon-btn icon-filter" (click)="openAdvancedSearchModal()" title="進階搜尋">
          <i class="fas fa-sliders-h"></i>
        </button>
      </div>
<!-- ✅ 進階搜尋彈跳視窗（Modal） -->
<div class="modal-backdrop" *ngIf="showAdvancedSearch">
  <div class="modal">
    <h3>進階搜尋條件</h3>

    <div class="form-group">
      <label>關鍵字：</label>
      <input type="text" [(ngModel)]="tempSearchCriteria.keyword" />
    </div>

    <div class="form-group">
      <label>搜尋欄位：</label>
      <div class="custom-checkbox-row">
        <div class="custom-checkbox">
          <input type="checkbox" id="field-title" [(ngModel)]="tempSearchCriteria.searchFields.title" />
          <label for="field-title">標題</label>
        </div>
        <div class="custom-checkbox">
          <input type="checkbox" id="field-content" [(ngModel)]="tempSearchCriteria.searchFields.content" />
          <label for="field-content">內容</label>
        </div>
        <div class="custom-checkbox">
          <input type="checkbox" id="field-tag" [(ngModel)]="tempSearchCriteria.searchFields.tag" />
          <label for="field-tag">標籤</label>
        </div>
      </div>
    </div>
    

    <div class="form-group">
      <label>日期區間：</label>
      <input type="date" [(ngModel)]="tempSearchCriteria.startDate" />
      ~
      <input type="date" [(ngModel)]="tempSearchCriteria.endDate" />
    </div>

    <div class="form-group">
      <label>優先級：</label>
      <select [(ngModel)]="tempSearchCriteria.priorityLevel">
        <option value="">全部</option>
        <option value="1-2">普通</option>
        <option value="3-4">重要</option>
        <option value="5">極重要</option>
      </select>
    </div>

    <div class="form-group">
      <label>標籤：</label>
      <input type="text" [(ngModel)]="tempSearchCriteria.tag" />
    </div>

    <div class="form-group">
      <label>完成狀態：</label>
      <select [(ngModel)]="tempSearchCriteria.completionStatus">
        <option value="all">全部</option>
        <option value="completed">已完成</option>
        <option value="uncompleted">未完成</option>
      </select>
    </div>

    <div class="form-actions modal-actions">
      <button class="confirm-btn" (click)="applyAdvancedSearch()" title="確認搜尋">
        <i class="fas fa-check"></i>
      </button>
      <button class="cancel-btn" (click)="cancelAdvancedSearch()" title="取消">
        <i class="fas fa-times"></i>
      </button>
      <button class="clear-btn" (click)="clearAdvancedSearch()" title="清除條件">
        <i class="fas fa-broom"></i>
      </button>
    </div>
  </div>
</div>


      <ul>
        <li *ngFor="let todo of todos">
          <div class="todo-item">
            <!-- 按鈕移到右上角 -->
            <div class="todo-actions">
              <!-- 👁️ 閱讀更多（右上角） -->
              <button class="btn-info" [routerLink]="['/detail', todo.id]" title="閱讀更多">
                <i class="fas fa-eye"></i>
              </button>
            
              <!-- ✏️ 編輯 -->
              <button class="btn-warning" (click)="editTodo(todo)" title="編輯">
                <i class="fas fa-edit"></i>
              </button>
            
              <!-- 🗑️ 刪除 -->
              <button class="btn-danger" (click)="deleteTodo(todo.id)" title="刪除">
                <i class="fas fa-trash"></i>
              </button>
            </div>
      
            <div class="todo-header">
              <input
                type="checkbox"
                [checked]="todo.isCompleted"
                (change)="toggleComplete(todo, $event)"
              />
              <span class="todo-title">{{ todo.title }}</span>
              <span class="todo-date">{{ todo.date }}</span>
              <span class="todo-status" [ngClass]="{'completed': todo.isCompleted, 'uncompleted': !todo.isCompleted}">
                {{ todo.isCompleted ? '已完成' : '未完成' }}
              </span>
            </div>
            <!-- 移除「閱讀更多」鏈接 -->
            <div class="todo-footer">
              <div class="priority">
                優先級: 
                <span *ngIf="todo.priorityLevel <= 2">普通</span>
                <span *ngIf="todo.priorityLevel === 3 || todo.priorityLevel === 4">重要</span>
                <span *ngIf="todo.priorityLevel === 5">極為重要</span>
              </div>          
              <div class="tag-row">
                <span *ngFor="let tag of todo.category.split('#')">
                  <span *ngIf="tag" class="tag">#{{ tag }}</span>
                </span>
              </div>
            </div>
          </div>
        </li>
      </ul>

      <!-- 分頁控制 -->
      <div class="pagination" *ngIf="totalPages > 1">
        <button class="btn-pagination" (click)="prevPage()" [disabled]="currentPage === 1">
          <i class="fas fa-chevron-left"></i> 上一頁
        </button>
        <span>第 {{ currentPage }} 頁 / 共 {{ totalPages }} 頁</span>
        <button class="btn-pagination" (click)="nextPage()" [disabled]="currentPage === totalPages">
          下一頁 <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- 編輯事項 -->
    <div *ngIf="activeTab === 'edit' && editingTodo" class="detail-wrapper">
      <div class="detail-card">
        <!-- 右上角按鈕 -->
        <div class="button-group">
          <button class="btn-back" (click)="cancelEdit()" title="取消編輯">
            <i class="fas fa-arrow-left"></i>
          </button>
          <button class="btn-edit" (click)="updateTodo()" title="儲存">
            <i class="fas fa-save"></i>
          </button>
        </div>

        <h2>✏️ 編輯待辦事項</h2>

        <p>
          <strong>標題：</strong>
          <input type="text" [(ngModel)]="editingTodo.title" placeholder="輸入標題" />
        </p>

        <p>
          <strong>📄 內容：</strong>
          <textarea [(ngModel)]="editingTodo.content" placeholder="輸入內容"></textarea>
        </p>

        <p>
          <strong>📅 日期：</strong>
          <input type="datetime-local" [(ngModel)]="editingTodo.date" />
        </p>

        <!-- 優先級（星星） -->
        <div>
          <strong>🔥 優先級：</strong>
          <div class="star-rating">
            <i
              *ngFor="let star of [1, 2, 3, 4, 5]"
              class="fa-star"
              [class.fa-solid]="(editingTodo.priorityLevel ?? 0) >= star"
              [class.fa-regular]="(editingTodo.priorityLevel ?? 0) < star"
              (click)="editingTodo.priorityLevel = star"
            ></i>
          </div>
        </div>

        <div class="status-section">
          <strong>✅ 是否完成：</strong>
          <label>
            <input type="radio" name="isCompleted" [(ngModel)]="editingTodo.isCompleted" [value]="true" /> 是
          </label>
          <label>
            <input type="radio" name="isCompleted" [(ngModel)]="editingTodo.isCompleted" [value]="false" /> 否
          </label>
        </div>

        <p>
          <strong>📂 類別（最多三個）：</strong>
          <span class="tag" *ngFor="let tag of editingTags; let i = index">
            #{{ tag }} <button type="button" (click)="removeEditTag(i)">✖</button>
          </span>
          <input
            type="text"
            maxlength="10"
            [(ngModel)]="editingTagInput"
            placeholder="輸入標籤後按 Enter 或新增"
            (keydown.enter)="addEditTag()"
          />
          <button type="button" class="btn-add-tag" (click)="addEditTag()">新增標籤</button>
        </p>
      </div>
    </div>
  </main>
</div>